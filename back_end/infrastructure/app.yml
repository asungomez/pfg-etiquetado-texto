service: amplify-app

provider:
  name: aws
  profile: ${opt:aws-profile}
  region: ${opt:region}
  deploymentBucket:
    name: ${env:APP_NAME}-deployment-bucket
  stackName: ${env:APP_NAME}-amplify-app

resources:
  Resources:
    AmplifyRole:
      Type: AWS::IAM::Role
      DeletionPolicy: Delete
      Properties:
        RoleName: ${env:APP_NAME}-amplify-role
        Description: Amplify app IAM role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - amplify.amazonaws.com
              Action:
                - sts:AssumeRole
    AmplifyApp:
      DependsOn:
        - AmplifyRole
      Type: AWS::Amplify::App
      DeletionPolicy: Delete
      Properties:
        CustomRules: 
          - Source: "/site.webmanifest"
            Status: "200"
            Target: "/site.webmanifest"
          - Source: "/icon.ico"
            Status: "200"
            Target: "/icon.ico"
          - Source: "/icon16x16.png"
            Status: "200"
            Target: "/icon16x16.png"  
          - Source: "/icon32x32.png"
            Status: "200"
            Target: "/icon32x32.png"  
          - Source: "</^[^.]+$|\\.(?!(css|gif|ico|jpg|js|png|txt|svg|woff|ttf|map|json)$)([^.]+$)/>"
            Status: "200"
            Target: "/index.html"
          - Source: "/<*>"
            Status: "404"
            Target: "/index.html"
        Description: Amplify app for React app
        EnableBranchAutoDeletion: false
        EnvironmentVariables: 
          - Name: CHOKIDAR_USEPOLLING
            Value: "1"
          - Name: CI
            Value: "1"
          - Name: _LIVE_UPDATES
            Value: '[{"pkg":"@aws-amplify/cli","type":"npm","version":"latest"}]'
        IAMServiceRole: !GetAtt AmplifyRole.Arn
        Name: ${env:APP_NAME}-amplify-app
        OauthToken: ${env:GH_TOKEN}
        Repository: ${env:GH_REPO}
    AmplifyRolePolicy:
      DependsOn:
        - AmplifyRole
        - AmplifyApp
      Type: 'AWS::IAM::Policy'
      Properties:
        PolicyName: ${env:APP_NAME}-amplify-app
        Roles:
          - !Ref AmplifyRole
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - amplify:*
              Resource: !GetAtt AmplifyApp.Arn
  Outputs:
    AppId:
      Description: Amplify App ID
      Value: !GetAtt 
        - AmplifyApp
        - AppId
      Export:
        Name: ${env:APP_NAME}-amplify-app-id
